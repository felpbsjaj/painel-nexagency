<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexAgency - Sistema de Afiliados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; color: white; margin: 0; }
        .sidebar { background-color: #1a2235; border-right: 1px solid #2d3748; height: 100vh; position: sticky; top: 0; }
        .card-stat { background-color: transparent; border: 1px solid #334155; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 16px; transition: 0.3s; }
        .card-stat:hover { background-color: #1e293b; border-color: #4a5568; }
        .text-label { color: #94a3b8; font-size: 13px; font-weight: 600; }
        .text-value { font-size: 26px; font-weight: 800; color: #ffffff; }
        .highlight-blue { border: 1px solid #3b82f6 !important; }
        #modal-filtro { background-color: rgba(15, 23, 42, 0.9); }
        .modal-content { background-color: #1a2235; border: 1px solid #334155; width: 450px; }
        .input-data { background-color: #0f172a; border: 1px solid #334155; padding: 12px; border-radius: 8px; width: 100%; color: white; outline: none; }
        .input-data:focus { border-color: #a3e635; }
        .btn-aplicar { background-color: #a3e635; color: #0f172a; font-weight: 700; padding: 12px; border-radius: 8px; transition: 0.3s; }
        .btn-aplicar:hover { background-color: #bef264; }
        #toast { visibility: hidden; min-width: 280px; background-color: #a3e635; color: #0f172a; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 200; bottom: 30px; left: 50%; transform: translateX(-50%); font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="flex">

    <aside class="w-64 sidebar hidden md:flex flex-col p-6">
        <img src="https://res.cloudinary.com/dsreg6hmo/image/upload/v1767891428/BetBoard/Photos/gpkghm2vdoohymfufbuw.png" class="h-8 mb-10 w-fit">
        <nav class="space-y-4 flex-1">
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Menu Principal</p>
            <button onclick="mudarTab('overview')" id="btn-overview" class="flex items-center w-full text-blue-400 bg-slate-800/20 p-3 rounded-lg border-l-4 border-blue-500">
                <i data-lucide="layout-dashboard" class="mr-3 w-5 h-5"></i> Overview
            </button>
        </nav>
        <button onclick="logout()" class="flex items-center text-slate-500 hover:text-red-400 p-3 transition border-t border-slate-700 pt-6">
            <i data-lucide="log-out" class="mr-3 w-5 h-5"></i> Sair
        </button>
    </aside>

    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-6">
            <h2 id="titulo-pagina" class="text-2xl font-bold">Overview</h2>
            <div class="relative">
                <button onclick="toggleDropdown()" class="flex items-center gap-3 bg-transparent p-1 px-4 rounded-full border border-slate-700 hover:border-blue-500 transition">
                    <span id="top-user-name" class="text-sm font-medium text-slate-300 uppercase">...</span>
                    <div id="avatar-inicial" class="h-9 w-9 bg-slate-600 rounded-full flex items-center justify-center text-sm font-bold border border-blue-500 text-white uppercase">?</div>
                </button>
                <div id="dropdown" class="hidden absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-xl z-50 overflow-hidden shadow-2xl">
                    <button onclick="mudarTab('perfil')" class="flex items-center w-full p-4 text-sm text-slate-300 hover:bg-slate-700">
                        <i data-lucide="user-circle" class="mr-3 w-4 h-4 text-lime-400"></i> Meu Perfil
                    </button>
                    <button onclick="logout()" class="flex items-center w-full p-4 text-sm text-red-400 hover:bg-slate-700 border-t border-slate-700">
                        <i data-lucide="log-out" class="mr-3 w-4 h-4"></i> Sair
                    </button>
                </div>
            </div>
        </header>

        <div id="filtros-topo" class="mb-8">
            <button onclick="abrirModalFiltro()" class="flex items-center gap-2 px-4 py-2 bg-transparent border border-slate-700 rounded-md text-slate-400 hover:border-lime-400 transition">
                <i data-lucide="calendar" class="w-4 h-4 text-lime-400"></i>
                <span id="periodo-exibicao" class="text-xs font-medium uppercase">...</span>
            </button>
        </div>

        <div id="secao-overview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="card-stat"><img src="icones/rgst.svg" class="h-12"><div><p class="text-label uppercase">Registro</p><h3 id="registros" class="text-value">0</h3></div></div>
            <div class="card-stat"><img src="icones/FTD-BkwOULkh.svg" class="h-12"><div><p class="text-label uppercase">FTD</p><h3 id="ftd" class="text-value">0</h3></div></div>
            <div class="card-stat"><img src="icones/FTD-BkwOULkh.svg" class="h-12"><div><p class="text-label uppercase">QFTD</p><h3 id="qftd" class="text-value">0</h3></div></div>
            <div class="card-stat"><img src="icones/deposito-BqL6OVL2.svg" class="h-12"><div><p class="text-label uppercase">Depósito</p><h3 id="depositos" class="text-value">R$ 0,00</h3></div></div>
            <div class="card-stat"><img src="icones/Rev-Cd_d35Vr.svg" class="h-12"><div><p class="text-label uppercase">REV</p><h3 id="rev" class="text-value">R$ 0,00</h3></div></div>
            <div class="card-stat"><img src="icones/cpa.svg" class="h-12"><div><p class="text-label uppercase">CPA</p><h3 id="cpa" class="text-value">R$ 0,00</h3></div></div>
            <div class="card-stat"><img src="icones/cprev.svg" class="h-12"><div><p class="text-label uppercase">REV + CPA</p><h3 id="total" class="text-value">R$ 0,00</h3></div></div>
        </div>

        <div id="secao-perfil" class="hidden max-w-4xl mx-auto">
            <div class="bg-[#1a2235] border border-slate-700 p-10 rounded-2xl text-center">
                <div id="avatar-perfil-grande" class="h-32 w-32 bg-slate-700 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl font-bold border-4 border-slate-600 relative uppercase">?</div>
                <h2 class="text-2xl font-bold mb-4 uppercase tracking-tight">NEX AGENCY - <span id="perfil-nome-grande">...</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left mt-8">
                    <div class="card-stat border-slate-800"><i data-lucide="user" class="w-5 h-5 text-lime-400"></i><div><p class="text-label uppercase">Nome</p><p class="font-bold">NEX AGENCY -</p></div></div>
                    <div class="card-stat border-slate-800"><i data-lucide="user" class="w-5 h-5 text-lime-400"></i><div><p class="text-label uppercase">Sobrenome</p><p id="perfil-sobrenome" class="font-bold uppercase">...</p></div></div>
                    <div class="card-stat border-slate-800"><i data-lucide="shield-check" class="w-5 h-5 text-lime-400"></i><div><p class="text-label uppercase">Cargo</p><p class="font-bold text-green-400">Afiliado</p></div></div>
                    <div class="card-stat border-slate-800"><i data-lucide="mail" class="w-5 h-5 text-lime-400"></i><div><p class="text-label uppercase">E-mail</p><p class="font-bold text-slate-300">nexagency@affiliates.com</p></div></div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-filtro" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="modal-content p-8 rounded-xl relative shadow-2xl">
            <button onclick="fecharModalFiltro()" class="absolute top-4 right-4 text-slate-500 hover:text-white">✕</button>
            <h3 class="text-xl font-bold mb-1">Filtrar por Período</h3>
            <p class="text-slate-400 text-sm mb-8">Selecione o período de datas para filtrar os relatórios.</p>
            <div class="space-y-6">
                <div><label class="block text-xs font-bold text-slate-300 mb-2 uppercase">Data de Início</label><input type="date" id="modal-ini" class="input-data"></div>
                <div><label class="block text-xs font-bold text-slate-300 mb-2 uppercase">Data de Término</label><input type="date" id="modal-fim" class="input-data"></div>
            </div>
            <div class="flex gap-4 mt-10">
                <button onclick="fecharModalFiltro()" class="flex-1 bg-slate-800 py-3 rounded-lg font-bold">Cancelar</button>
                <button onclick="aplicarFiltroLocal()" class="btn-aplicar flex-1 uppercase">Aplicar Filtros</button>
            </div>
        </div>
    </div>

    <div id="toast">Filtros de data aplicados</div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC0oiw7obzsGDBvDr_enJQ1eNHmgPkwNA8", authDomain: "nexagency-84caa.firebaseapp.com", databaseURL: "https://nexagency-84caa-default-rtdb.firebaseio.com", projectId: "nexagency-84caa", storageBucket: "nexagency-84caa.firebasestorage.app", messagingSenderId: "691404707224", appId: "1:691404707224:web:8fed7daf6b4c7c9f8347ed" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const user = localStorage.getItem('usuarioLogado');
        if(!user) window.location.href = 'index.html';

        const inicial = user.charAt(0).toUpperCase();
        document.getElementById('avatar-inicial').innerText = inicial + "-";
        document.getElementById('avatar-perfil-grande').innerText = inicial + "-";
        document.getElementById('top-user-name').innerText = user;
        document.getElementById('perfil-nome-grande').innerText = user;
        document.getElementById('perfil-sobrenome').innerText = user;

        // Listener Principal: Soma todo o histórico de lançamentos
        db.ref('usuarios/' + user).on('value', (s) => {
            const d = s.val();
            if(d) {
                let r = 0, f = 0, dep = 0, cpa = 0;
                if(d.historico) {
                    Object.values(d.historico).forEach(dia => {
                        r += parseInt(dia.registros || 0);
                        f += parseInt(dia.ftd || 0);
                        dep += parseFloat(dia.depositos || 0);
                        cpa += parseFloat(dia.cpa || 0);
                    });
                }
                document.getElementById('registros').innerText = r;
                document.getElementById('ftd').innerText = f;
                document.getElementById('qftd').innerText = f;
                document.getElementById('depositos').innerText = "R$ " + dep.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('cpa').innerText = "R$ " + cpa.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('total').innerText = "R$ " + cpa.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                
                document.getElementById('periodo-exibicao').innerText = (d.dataInicio || "01/01/2026") + " - " + (d.dataFim || "31/01/2026");
                document.getElementById('modal-ini').value = d.dataInicio ? d.dataInicio.split('/').reverse().join('-') : "2026-01-01";
                document.getElementById('modal-fim').value = d.dataFim ? d.dataFim.split('/').reverse().join('-') : "2026-01-31";
            }
        });

        function aplicarFiltroLocal() {
            const di = document.getElementById('modal-ini').value.split('-').reverse().join('/');
            const df = document.getElementById('modal-fim').value.split('-').reverse().join('/');
            db.ref('usuarios/' + user).update({ dataInicio: di, dataFim: df }).then(() => {
                fecharModalFiltro();
                const t = document.getElementById("toast"); t.className = "show";
                setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
            });
        }

        function abrirModalFiltro() { document.getElementById('modal-filtro').classList.remove('hidden'); }
        function fecharModalFiltro() { document.getElementById('modal-filtro').classList.add('hidden'); }
        function toggleDropdown() { document.getElementById('dropdown').classList.toggle('hidden'); }
        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        function mudarTab(tab) {
            document.getElementById('secao-overview').classList.toggle('hidden', tab !== 'overview');
            document.getElementById('secao-perfil').classList.toggle('hidden', tab !== 'perfil');
            document.getElementById('filtros-topo').classList.toggle('hidden', tab !== 'overview');
            document.getElementById('titulo-pagina').innerText = tab === 'overview' ? 'Overview' : 'Meu Perfil';
            document.getElementById('dropdown').classList.add('hidden');
        }
        lucide.createIcons();
    </script>
</body>
</html>
